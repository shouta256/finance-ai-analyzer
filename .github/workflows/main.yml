name: Build, Push, and Deploy (ECR → ECS)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  id-token: write          # for GitHub OIDC → AWS
  contents: read

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  AWS_REGION:     ${{ secrets.AWS_REGION }}
  AWS_ROLE_ARN:   ${{ secrets.AWS_ROLE_ARN }}
  ECR_REGISTRY:   ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  SHA:            ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # GitHub → AWS (OIDC)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR login（公式アクション推奨）
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: 'true'

      # buildx（Fargate 向け linux/amd64）
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      # ===== Web =====
      - name: Build & Push next-web
        uses: docker/build-push-action@v6
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/safepocket/next-web:${{ github.sha }}
            ${{ github.ref == 'refs/heads/main' && format('{0}.dkr.ecr.{1}.amazonaws.com/safepocket/next-web:latest', secrets.AWS_ACCOUNT_ID, secrets.AWS_REGION) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== Backend =====
      - name: Build & Push ledger-svc
        uses: docker/build-push-action@v6
        with:
          context: ./apps/ledger-svc
          file: ./apps/ledger-svc/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/safepocket/ledger-svc:${{ github.sha }}
            ${{ github.ref == 'refs/heads/main' && format('{0}.dkr.ecr.{1}.amazonaws.com/safepocket/ledger-svc:latest', secrets.AWS_ACCOUNT_ID, secrets.AWS_REGION) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-web:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      CLUSTER:         safepocket-cluster
      SERVICE:         safepocket-next-web-service-68os670g
      CONTAINER_NAME:  next-web
      IMAGE:           ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/safepocket/next-web:${{ github.sha }}
      # ==== Web (Next.js) runtime & build cognito related env (set these in GitHub Secrets) ====
      NEXT_PUBLIC_COGNITO_DOMAIN: ${{ secrets.NEXT_PUBLIC_COGNITO_DOMAIN }}
      NEXT_PUBLIC_COGNITO_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_COGNITO_CLIENT_ID }}
      NEXT_PUBLIC_COGNITO_SCOPE: ${{ secrets.NEXT_PUBLIC_COGNITO_SCOPE }}
      # Redirect URI (set this secret). If legacy *_REDIRECT_URL was used previously, rename it to *_REDIRECT_URI.
      NEXT_PUBLIC_COGNITO_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_COGNITO_REDIRECT_URI }}
      COGNITO_CLIENT_SECRET: ${{ secrets.COGNITO_CLIENT_SECRET }}
      COGNITO_DOMAIN: ${{ secrets.COGNITO_DOMAIN }}
      COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
      COGNITO_REDIRECT_URI: ${{ secrets.COGNITO_REDIRECT_URI }}
      SAFEPOCKET_USE_COGNITO: ${{ secrets.SAFEPOCKET_USE_COGNITO }}
    # Ensure all above secrets exist. SAFEPOCKET_USE_COGNITO should be 'true' in production.
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Preflight ECS permission check
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking ecs:DescribeServices for $CLUSTER / $SERVICE" >&2
          if ! aws ecs describe-services --region "$AWS_REGION" --cluster "$CLUSTER" --services "$SERVICE" --query 'services[0].status' --output text >/dev/null 2>&1; then
            echo "::error::ecs:DescribeServices failed. Ensure the GitHubOIDCDeployRole has ecs:DescribeServices on service ARN" >&2
            exit 1
          fi
          echo "Permission OK" >&2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Render new task definition (image swap + env overrides)
        id: render
        shell: bash
        run: |
          set -euo pipefail
          TD_ARN=$(aws ecs describe-services --region "$AWS_REGION" --cluster "$CLUSTER" --services "$SERVICE" \
            --query 'services[0].taskDefinition' --output text)
          aws ecs describe-task-definition --region "$AWS_REGION" --task-definition "$TD_ARN" \
            --query 'taskDefinition' > td.json

          # strip read-only fields
          jq 'del(.taskDefinitionArn,.revision,.status,.registeredAt,.registeredBy,.compatibilities,.requiresAttributes)' td.json > td.base.json

          # build env override JSON only for non-empty vars to avoid clobbering with null
          make_env_entry() { # name value
            if [ -n "$2" ]; then
              printf '{"name":"%s","value":"%s"}' "$1" "$2"
            fi
          }
          ENV_OVERRIDES=$(jq -n '[]')
          for VAR in \
            NEXT_PUBLIC_COGNITO_DOMAIN \
            NEXT_PUBLIC_COGNITO_CLIENT_ID \
            NEXT_PUBLIC_COGNITO_SCOPE \
            NEXT_PUBLIC_COGNITO_REDIRECT_URI \
            COGNITO_CLIENT_SECRET \
            COGNITO_DOMAIN \
            COGNITO_CLIENT_ID \
            COGNITO_REDIRECT_URI \
            SAFEPOCKET_USE_COGNITO; do
            VAL="${!VAR:-}"
            if [ -n "$VAL" ]; then
              ENV_OVERRIDES=$(echo "$ENV_OVERRIDES" | jq --arg n "$VAR" --arg v "$VAL" '. + [{name:$n,value:$v}]')
            fi
          done

          # swap container image & merge env (remove duplicates by name)
          jq --arg name "$CONTAINER_NAME" --arg img "$IMAGE" --argjson overrides "$ENV_OVERRIDES" '
            .containerDefinitions = (.containerDefinitions | map(
              if .name==$name then
                .image=$img |
                (.environment) as $orig |
                (.environment = ((($orig // []) | map(select([.name] | inside([ $overrides[].name ]) | not))) + $overrides))
              else . end))' td.base.json > td.new.json

          NEW_TD_ARN=$(aws ecs register-task-definition --region "$AWS_REGION" \
            --cli-input-json file://td.new.json \
            --query 'taskDefinition.taskDefinitionArn' --output text)
          echo "NEW_TD_ARN=$NEW_TD_ARN" >> $GITHUB_OUTPUT

      - name: Update service
        run: |
          aws ecs update-service --region "$AWS_REGION" \
            --cluster "$CLUSTER" --service "$SERVICE" \
            --task-definition "${{ steps.render.outputs.NEW_TD_ARN }}" \
            --force-new-deployment >/dev/null
          aws ecs wait services-stable --region "$AWS_REGION" --cluster "$CLUSTER" --services "$SERVICE"

  deploy-be:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      CLUSTER:         safepocket-cluster
      SERVICE:         safepocket-ledger-svc-service-2f0u2cu0
      CONTAINER_NAME:  ledger-svc
      IMAGE:           ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/safepocket/ledger-svc:${{ github.sha }}
      # ==== Backend (Spring) Cognito runtime vars ====
      COGNITO_ISSUER: ${{ secrets.COGNITO_ISSUER }}
      COGNITO_AUDIENCE: ${{ secrets.COGNITO_AUDIENCE }}
      SAFEPOCKET_USE_COGNITO: ${{ secrets.SAFEPOCKET_USE_COGNITO }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Preflight ECS permission check
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking ecs:DescribeServices for $CLUSTER / $SERVICE" >&2
          if ! aws ecs describe-services --region "$AWS_REGION" --cluster "$CLUSTER" --services "$SERVICE" --query 'services[0].status' --output text >/dev/null 2>&1; then
            echo "::error::ecs:DescribeServices failed. Ensure the GitHubOIDCDeployRole has ecs:DescribeServices on service ARN" >&2
            exit 1
          fi
          echo "Permission OK" >&2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Render new task definition (image swap + env overrides)
        id: render
        shell: bash
        run: |
          set -euo pipefail
          TD_ARN=$(aws ecs describe-services --region "$AWS_REGION" --cluster "$CLUSTER" --services "$SERVICE" \
            --query 'services[0].taskDefinition' --output text)
          aws ecs describe-task-definition --region "$AWS_REGION" --task-definition "$TD_ARN" \
            --query 'taskDefinition' > td.json

          jq 'del(.taskDefinitionArn,.revision,.status,.registeredAt,.registeredBy,.compatibilities,.requiresAttributes)' td.json > td.base.json

          ENV_OVERRIDES=$(jq -n '[]')
          for VAR in \
            COGNITO_ISSUER \
            COGNITO_AUDIENCE \
            SAFEPOCKET_USE_COGNITO; do
            VAL="${!VAR:-}"
            if [ -n "$VAL" ]; then
              ENV_OVERRIDES=$(echo "$ENV_OVERRIDES" | jq --arg n "$VAR" --arg v "$VAL" '. + [{name:$n,value:$v}]')
            fi
          done

          jq --arg name "$CONTAINER_NAME" --arg img "$IMAGE" --argjson overrides "$ENV_OVERRIDES" '
            .containerDefinitions = (.containerDefinitions | map(
              if .name==$name then
                .image=$img |
                (.environment) as $orig |
                (.environment = ((($orig // []) | map(select([.name] | inside([ $overrides[].name ]) | not))) + $overrides))
              else . end))' td.base.json > td.new.json

          NEW_TD_ARN=$(aws ecs register-task-definition --region "$AWS_REGION" \
            --cli-input-json file://td.new.json \
            --query 'taskDefinition.taskDefinitionArn' --output text)
          echo "NEW_TD_ARN=$NEW_TD_ARN" >> $GITHUB_OUTPUT

      - name: Update service
        run: |
          aws ecs update-service --region "$AWS_REGION" \
            --cluster "$CLUSTER" --service "$SERVICE" \
            --task-definition "${{ steps.render.outputs.NEW_TD_ARN }}" \
            --force-new-deployment >/dev/null
          aws ecs wait services-stable --region "$AWS_REGION" --cluster "$CLUSTER" --services "$SERVICE"
